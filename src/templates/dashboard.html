<!DOCTYPE html>
<html>

<head>
    <title>Weather Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            padding: 10px;
            font-size: 16px;
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .weather-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .weather-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #007bff;
        }

        .weather-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }

        .weather-label {
            color: #666;
            font-size: 14px;
        }

        .chart-container {
            margin-top: 30px;
        }

        .error {
            color: red;
            margin: 10px 0;
        }

        #d3ChartContainer {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: #f9f9f9;
        }

        .chart-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        #d3ChartContainer {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
            margin-top: 15px;
            min-height: 450px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Tooltip styling */
        .tooltip {
            background: white !important;
            border-radius: 6px !important;
            padding: 10px 15px !important;
            border: 1px solid #ddd !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            font-family: Arial, sans-serif !important;
            font-size: 13px !important;
            z-index: 1000 !important;
        }

        .chart-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            display: inline-block;
        }

        /* Axis styling */
        .grid line {
            stroke: #ecf0f1;
            stroke-opacity: 0.7;
        }

        /* ========== ANIMATED WEATHER BACKGROUND ========== */
        body {
            position: relative;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .weather-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
        }

        /* Base weather elements */
        .sun {
            position: absolute;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, #ffd700, #ff8c00);
            border-radius: 50%;
            box-shadow: 0 0 60px 30px #ffa500, 0 0 100px 60px #ff4500;
            top: 20%;
            right: 10%;
            animation: float 20s infinite ease-in-out;
        }

        .cloud {
            position: absolute;
            width: 150px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50px;
            top: 30%;
            left: 5%;
        }

        .cloud:before,
        .cloud:after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
        }

        .cloud:before {
            width: 80px;
            height: 80px;
            top: -40px;
            left: 20px;
        }

        .cloud:after {
            width: 60px;
            height: 60px;
            top: -30px;
            right: 20px;
        }

        .snowflake {
            position: absolute;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px white;
        }

        /* Animations */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes snowFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
            }

            100% {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        @keyframes cloudMove {
            0% {
                transform: translateX(-200px);
            }

            100% {
                transform: translateX(calc(100vw + 200px));
            }
        }

        @keyframes sunPulse {

            0%,
            100% {
                opacity: 0.8;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        /* Temperature-based backgrounds */
        .background-cold {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .background-cool {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
        }

        .background-moderate {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
        }

        .background-warm {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .background-hot {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        }

        /* Make container semi-transparent */
        .container {
            background: rgba(255, 255, 255, 0.92) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* ========== END ANIMATED BACKGROUND ========== */
    </style>
</head>

<body>
    <!-- Animated Weather Background -->
    <div id="weatherBackground" class="weather-background"></div>
    <div class="container">
        <h1>üå§Ô∏è Real-Time Weather Dashboard</h1>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" id="citySearch" placeholder="Enter any city name (e.g., London, Tokyo, New York)">
            <button onclick="searchCity()">Search Live Weather</button>
        </div>
        <div id="errorMessage" class="error"></div>

        <!-- Live Weather Display -->
        <div id="liveWeather" style="display: none;">
            <h2>Current Weather in <span id="currentCity"></span></h2>
            <div class="weather-cards">
                <div class="weather-card">
                    <div class="weather-label">Temperature</div>
                    <div class="weather-value" id="tempValue">--¬∞C</div>
                </div>
                <div class="weather-card">
                    <div class="weather-label">Wind Speed</div>
                    <div class="weather-value" id="windValue">-- m/s</div>
                </div>
                <div class="weather-card">
                    <div class="weather-label">Humidity</div>
                    <div class="weather-value" id="humidityValue">--%</div>
                </div>
                <div class="weather-card">
                    <div class="weather-label">Cloud Cover</div>
                    <div class="weather-value" id="cloudValue">--%</div>
                </div>
            </div>
        </div>

        <!-- Historical Chart with D3.js -->
        <div class="chart-section">
            <h3>üìà Temperature History (D3.js)</h3>
            <select id="citySelect">
                <option value="">-- Choose a City --</option>
                {% for city in cities %}
                <option value="{{ city }}">{{ city }}</option>
                {% endfor %}
            </select>
            <div id="d3ChartContainer"></div>
        </div>
    </div>

    <script>
        // ========== WEATHER BACKGROUND FUNCTIONS ==========

        function updateWeatherBackground(temperature) {
            const background = document.getElementById('weatherBackground');

            // Clear previous background elements
            background.innerHTML = '';

            // Remove all background classes
            background.className = 'weather-background';

            // Determine weather type based on temperature
            let weatherType, backgroundColor;

            if (temperature < 0) {
                weatherType = 'freezing';
                backgroundColor = 'background-cold';
                createSnowEffect(background);
            } else if (temperature < 10) {
                weatherType = 'cold';
                backgroundColor = 'background-cold';
                createCloudEffect(background);
            } else if (temperature < 20) {
                weatherType = 'cool';
                backgroundColor = 'background-cool';
                createSunCloudEffect(background);
            } else if (temperature < 30) {
                weatherType = 'warm';
                backgroundColor = 'background-warm';
                createSunEffect(background);
            } else {
                weatherType = 'hot';
                backgroundColor = 'background-hot';
                createHotSunEffect(background);
            }

            // Add background color class
            background.classList.add(backgroundColor);
        }

        function createSnowEffect(container) {
            for (let i = 0; i < 50; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.style.width = snowflake.style.height = Math.random() * 5 + 2 + 'px';
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.animation = `snowFall ${Math.random() * 5 + 5}s linear infinite`;
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(snowflake);
            }
        }

        function createCloudEffect(container) {
            for (let i = 0; i < 5; i++) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.style.top = Math.random() * 50 + 10 + '%';
                cloud.style.left = Math.random() * 100 + 'vw';
                cloud.style.opacity = Math.random() * 0.5 + 0.3;
                cloud.style.animation = `cloudMove ${Math.random() * 40 + 30}s linear infinite`;
                cloud.style.animationDelay = Math.random() * 10 + 's';
                container.appendChild(cloud);
            }
        }

        function createSunCloudEffect(container) {
            const sun = document.createElement('div');
            sun.className = 'sun';
            sun.style.animation = 'sunPulse 5s infinite ease-in-out';
            container.appendChild(sun);

            createCloudEffect(container);
        }

        function createSunEffect(container) {
            const sun = document.createElement('div');
            sun.className = 'sun';
            sun.style.boxShadow = '0 0 80px 40px #ffa500, 0 0 120px 80px #ff4500';
            sun.style.animation = 'float 15s infinite ease-in-out, sunPulse 3s infinite ease-in-out';
            container.appendChild(sun);
        }

        function createHotSunEffect(container) {
            const sun = document.createElement('div');
            sun.className = 'sun';
            sun.style.width = '150px';
            sun.style.height = '150px';
            sun.style.background = 'radial-gradient(circle, #ff4500, #ff8c00)';
            sun.style.boxShadow = '0 0 100px 50px #ff4500, 0 0 150px 100px #ff6347';
            sun.style.animation = 'float 10s infinite ease-in-out, sunPulse 2s infinite ease-in-out';
            container.appendChild(sun);
        }

        // Set initial background (moderate temperature)
        updateWeatherBackground(15); // Default cool background
        // ========== END WEATHER BACKGROUND ==========
        // D3.js Chart Function
        function createD3Chart(weatherData, cityName) {
            // Clear previous chart
            d3.select("#d3ChartContainer").html("");

            // Set up dimensions
            const width = 800;
            const height = 400;
            const margin = { top: 40, right: 40, bottom: 60, left: 70 };

            // Create SVG with background
            const svg = d3.select("#d3ChartContainer")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .style("background", "white")
                .style("border-radius", "8px")
                .style("box-shadow", "0 2px 8px rgba(0,0,0,0.1)");

            const chartGroup = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // Parse dates - fix for your timestamp format
            weatherData.forEach(d => {
                // Handle different timestamp formats
                try {
                    d.time = new Date(d.time);
                } catch (e) {
                    d.time = new Date(); // Fallback to current time
                }
                d.temperature = +d.temperature;
            });

            // Create scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(weatherData, d => d.time))
                .range([0, chartWidth])
                .nice();

            const yScale = d3.scaleLinear()
                .domain([
                    Math.min(0, d3.min(weatherData, d => d.temperature) - 2),
                    d3.max(weatherData, d => d.temperature) + 2
                ])
                .range([chartHeight, 0])
                .nice();

            // Add grid lines
            // Vertical grid
            chartGroup.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale)
                    .tickSize(-chartHeight)
                    .tickFormat("")
                )
                .style("opacity", 0.3)
                .style("stroke-dasharray", "2,2");

            // Horizontal grid
            chartGroup.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale)
                    .tickSize(-chartWidth)
                    .tickFormat("")
                )
                .style("opacity", 0.3)
                .style("stroke-dasharray", "2,2");

            // Create area under the line
            const area = d3.area()
                .x(d => xScale(d.time))
                .y0(chartHeight)
                .y1(d => yScale(d.temperature))
                .curve(d3.curveMonotoneX);

            chartGroup.append("path")
                .datum(weatherData)
                .attr("fill", "rgba(52, 152, 219, 0.2)")
                .attr("d", area);

            // Create line generator with smooth curve
            const line = d3.line()
                .x(d => xScale(d.time))
                .y(d => yScale(d.temperature))
                .curve(d3.curveMonotoneX);

            // Add line
            chartGroup.append("path")
                .datum(weatherData)
                .attr("fill", "none")
                .attr("stroke", "#3498db")
                .attr("stroke-width", 3)
                .attr("d", line);

            // Add circles for data points with hover effect
            const points = chartGroup.selectAll("circle")
                .data(weatherData)
                .enter()
                .append("circle")
                .attr("cx", d => xScale(d.time))
                .attr("cy", d => yScale(d.temperature))
                .attr("r", 5)
                .attr("fill", "#e74c3c")
                .attr("stroke", "white")
                .attr("stroke-width", 2)
                .style("cursor", "pointer");

            // Add tooltip
            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background", "white")
                .style("padding", "8px 12px")
                .style("border", "1px solid #ddd")
                .style("border-radius", "4px")
                .style("font-size", "12px")
                .style("pointer-events", "none")
                .style("opacity", 0)
                .style("box-shadow", "0 2px 4px rgba(0,0,0,0.1)");

            points.on("mouseover", function (event, d) {
                tooltip.transition().duration(200).style("opacity", 1);
                tooltip.html(`
            <strong>${d.time.toLocaleString()}</strong><br>
            Temp: <b>${d.temperature.toFixed(1)}¬∞C</b>
        `)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 40) + "px");

                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("r", 8)
                    .attr("fill", "#2ecc71");
            })
                .on("mouseout", function () {
                    tooltip.transition().duration(200).style("opacity", 0);
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", 5)
                        .attr("fill", "#e74c3c");
                });

            // Add X axis with better formatting
            const xAxis = chartGroup.append("g")
                .attr("transform", `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale)
                    .ticks(d3.timeHour.every(3)) // Show every 3 hours
                    .tickFormat(d3.timeFormat("%H:%M"))
                )
                .style("font-size", "12px")
                .style("color", "#555");

            // Add Y axis
            const yAxis = chartGroup.append("g")
                .call(d3.axisLeft(yScale)
                    .ticks(8)
                )
                .style("font-size", "12px")
                .style("color", "#555");

            // Add X axis label
            chartGroup.append("text")
                .attr("x", chartWidth / 2)
                .attr("y", chartHeight + 45)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "600")
                .style("fill", "#333")
                .text("Time (UTC)");

            // Add Y axis label
            chartGroup.append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -chartHeight / 2)
                .attr("y", -55)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "600")
                .style("fill", "#333")
                .text("Temperature (¬∞C)");

            // Add chart title
            chartGroup.append("text")
                .attr("x", chartWidth / 2)
                .attr("y", -15)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("font-weight", "bold")
                .style("fill", "#2c3e50")
                .text(`Temperature History - ${cityName}`);

            // Add a subtle border around the chart area
            chartGroup.append("rect")
                .attr("width", chartWidth)
                .attr("height", chartHeight)
                .attr("fill", "none")
                .attr("stroke", "#ecf0f1")
                .attr("stroke-width", 1);
        }

        // Search for live weather
        function searchCity() {
            const city = document.getElementById('citySearch').value.trim();
            const errorDiv = document.getElementById('errorMessage');

            if (!city) {
                errorDiv.textContent = 'Please enter a city name';
                return;
            }

            errorDiv.textContent = '';

            // Show loading
            document.getElementById('liveWeather').style.display = 'block';
            document.getElementById('currentCity').textContent = city;
            document.getElementById('tempValue').textContent = 'Loading...';
            document.getElementById('windValue').textContent = 'Loading...';
            document.getElementById('humidityValue').textContent = 'Loading...';
            document.getElementById('cloudValue').textContent = 'Loading...';

            // Fetch LIVE weather data
            fetch('/api/live-weather', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city: city })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        errorDiv.textContent = data.error;
                        document.getElementById('liveWeather').style.display = 'none';
                    } else {
                        // Update live weather display
                        document.getElementById('tempValue').textContent = data.temperature + '¬∞C';
                        document.getElementById('windValue').textContent = data.windspeed + ' m/s';
                        document.getElementById('humidityValue').textContent = data.humidity + '%';
                        document.getElementById('cloudValue').textContent = data.cloudcover + '%';

                        // Update weather background
                        updateWeatherBackground(data.temperature);

                        // Also load historical data for this city
                        loadHistoricalData(city);
                    }
                })
                .catch(error => {
                    errorDiv.textContent = 'Error fetching weather data';
                    console.error('Error:', error);
                });
        }

        // Load historical data for chart
        function loadHistoricalData(city) {
            fetch(`/api/weather/${city}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        createD3Chart(data, city);  // Use D3.js instead of Chart.js
                    }
                });
        }

        // Historical chart for predefined cities
        document.getElementById('citySelect').addEventListener('change', function () {
            const city = this.value;
            if (city) {
                loadHistoricalData(city);
            }
        });

        // Allow pressing Enter to search
        document.getElementById('citySearch').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchCity();
            }
        });

        // Load initial data for first city on page load
        window.addEventListener('load', function () {
            // Optionally load data for the first city automatically
            // const firstCity = document.querySelector('#citySelect option:nth-child(2)').value;
            // if (firstCity) {
            //     loadHistoricalData(firstCity);
            // }
        });
    </script>
</body>

</html>